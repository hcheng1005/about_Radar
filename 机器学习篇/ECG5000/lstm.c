#include <math.h>
#include <stdio.h>

#include "lstm.h"

// 模型参数
double wi[] = {-0.32707688, 0.329565, 0.50048375, -0.4185699, -0.11507357, -0.09997229, 0.19259112, 0.11276137, -0.52316463, 0.6322167, -0.38186488, -0.12821569, -0.11206903, -0.01400464, -0.33828154, -0.36966196, 0.07134613, 0.45368654, 0.59821844, 0.010161294, 0.058007296, 0.74989074, 0.8279741, 0.90300506, 0.23330337, -0.5235114, -0.03214243, -0.09371767, -0.009755905, 0.5475383, 0.050218996, -0.3873531, -0.4197865, -0.20415843, -0.43260643, 0.5270589, 0.4084122, 0.20833881, -0.31027296, 0.068497024, -0.37535262, 0.87282264, 0.46319038, 1.0461209, 0.1735276, 1.034427, 0.39528218, 0.920745, 0.90658903, -0.15852799, 0.768772, -0.060635198, 0.12230241, 0.63710225, -0.5939934, -0.4577439, 0.07602862, 0.25849518, 0.089188345, -0.13325661, 0.082963526, -0.28975746, -0.8197661, -0.46855125, 0.07129754, 0.6070345, 0.48244426, 0.100889415, -0.24496393, -0.3397264, -0.5231114, -0.034876242, -0.374129, 0.77996725, -0.37892282, 0.22409144, -0.0508769, -0.42331427, 0.08158952, -0.26457435, -0.52389085, 0.24818504, 0.08064052, -0.2820086, 0.35782838, 0.3719807, 0.08847668, -0.29243544, -0.11555741, 0.39074373, -0.20051925, 0.46717945, -0.17018797, -0.7372923, 0.019600281, 0.07601231, 0.45505562, -0.8327522, 0.3141766, -0.09446657, 0.49398258, -0.117950454, 0.2029797, 0.61725616, 1.0128971, 0.5179586, 1.1084231, 1.180088, 0.46507674, 0.088329054, 0.37246436, -0.08968309, 0.3833957, 0.22642392, 0.061625183, -0.21428986, 0.5028416, -0.48370552, -0.31819597, -0.30724207, 0.56481117, -0.07172055, 0.346071, -0.4627134, 0.27806136, -0.54147375, -1.2841396, -0.4307265, -0.112698145, -0.4797908, 0.065112054, -0.43747768, 0.36437067, 0.2433937, -0.2705779, -0.27297992, -0.08032617, 0.60196775, 0.34278277, 0.49250507, 0.027344495, 0.40843236, -0.8141097, -0.60828495, -0.803629, -0.8365449, -0.108640015, -0.31565657, 0.5121116, -0.54859185, 0.18611698, 0.5159428, -0.4016526, -0.017050618, 0.5550972, 0.24297565, -0.7804927, 0.25912058, -0.48498666, 0.35969532, -0.29932937, -0.1808554, -0.46803945, -0.16844878, 0.27576375, 0.29258254, 0.32811192, -0.27260873, -0.64809906, 0.039318234, -0.5316164, 0.37097496, -0.6342602, -0.43149954, 0.5465468, 0.12910028, -0.36666092, -0.47592273, 0.0720695, -0.57662064, -0.9109874, -0.08380192, -0.3670382, -0.043445885, -0.6106117, 0.51226807, -0.44262576, 0.10938618, -0.27492097, 0.6378743, -0.35142857, -0.17848356, 0.062807634, 0.19578636, -0.44689962, 0.12505369, -0.04664603, 0.18034473, 0.7177504, 0.56792164, 0.44000858, -0.5541039, -0.47845694, -0.003967577, -0.5256316, 0.046122186, 0.109086625, -0.26170078, -0.38614178, -0.26765993, -0.43897033, -0.36451626, 0.1742976, 0.38853043, 0.54596275, -0.68152773, -0.6440228, -0.37059486, -0.06941149, -0.038248245, -0.35717404, 0.14295661, -0.0075126756, 0.06092032, 0.37843657, 0.58940613, -0.6450155, 0.28809893, -0.6710815, 0.536032, -0.02634118, 0.21579356, -0.6165719, 0.7058762, -0.21549818, -0.35688487, -0.38857526, -0.5935358, 0.27359855, -0.36839136, -0.28072104, 0.5296389, 0.7092161, 0.42994156, -0.060938004, -0.3491392, -0.3118727, -0.054120027, -0.3946101, 0.21608019, 0.06824581, 0.63321674, 0.27399668, -0.21185555, -0.18163106, 0.080516204, 0.6393764, -0.37491238, -0.5066654, 0.33113322, 0.8725264, 0.61554193, 0.18278776, 0.1777052, 0.22444937, -0.36652744, 0.75633526, 0.2639373, -0.40522027, -0.21265607, -0.40859178, 0.11832183, -0.30367267, -0.10151639, -0.20893113, 0.09660343, 0.117133796, -0.989877, -0.68355817, -0.77683693};
double bi[] = {-0.5461353, -0.28181377};
double wf[] = {0.28158122, -0.30287585, 0.43040746, -0.4380928, -0.69241554, 0.03455943, -0.183227, 0.41669422, 0.5663025, 0.37641698, 0.44653875, -0.46979254, 0.6518802, -0.5223738, -0.099912584, 0.24139643, 0.11538297, -0.04502219, -0.02087146, 0.07052255, -0.54976624, -0.1060226, -0.35123968, -0.46052545, 0.14457357, 0.5026429, 0.53497905, 0.56547636, 0.249618, 0.19001418, 0.36163217, -0.4424543, 0.07948345, -0.06978834, -0.61017907, 0.46482593, 0.025033891, 0.48551363, -0.05658984, 0.386568, 0.25363165, 0.25280732, 0.41204852, -0.29807135, -0.55071515, -0.20989618, 0.46903056, 0.17914039, -0.60530907, 0.16984397, -0.18162698, 0.18898833, 0.5872902, -0.19277233, -0.49704435, 0.2584502, 0.50538605, 0.70259863, 0.68276566, 0.41791064, 0.50010055, -0.091186166, -0.5306036, -0.13095742, 0.6702625, 0.0014393926, -0.032309532, -0.68828624, -0.45173877, -0.55674964, 0.49246556, -0.2441454, -0.18783045, 0.21526855, 0.36749607, -0.50116014, -0.5746145, -0.48187333, -0.396902, 0.3268748, -0.5467378, -0.6922862, 0.6534528, -0.05847299, -0.67251736, -0.29723895, 0.5782923, 0.29039717, 0.120297074, 0.4036047, -0.14073813, 0.21030492, 0.24258012, 0.004707396, -0.0189929, 0.27935588, -0.46773762, -0.091049075, 0.216061, -0.21295124, -0.14727068, 0.5515942, 0.50351936, -0.49273762, 0.37272865, 0.4665206, -0.38773042, -0.4691831, 0.20522583, -0.13925815, -0.055754066, -0.36955622, 0.6485564, 0.26626253, 0.048050523, -0.6380281, -0.52047294, 0.4789967, 0.19133979, -0.29903653, 0.5229327, -0.27980113, -0.26025787, 0.59213156, 0.23305565, 0.27668917, -0.32513705, 0.49157363, -0.24317822, -0.6102298, 0.63395447, 0.0821991, -0.19672346, -0.4306811, 0.27813023, -0.242773, 0.61003166, 0.66811913, 0.4322024, -0.43169895, 0.4154901, 0.38490158, -0.39466015, -0.31641182, 0.13024104, -0.025176644, 0.22520703, -0.3106506, -0.21073043, -0.64661306, -0.21710399, 0.41552657, 0.50242096, 0.20416707, -0.28357098, -0.52084434, 0.543847, 0.5556596, 0.27847224, 0.08338815, 0.5392818, 0.1959014, -0.40779537, -0.08880383, -0.19791222, -0.65088344, -0.10630709, 0.6275, -0.10052067, 0.4734319, -0.50534713, -0.68079215, 0.5848475, -0.3050984, -0.06857556, -0.494959, -0.5817747, -0.008541048, -0.16244382, 0.5218385, -0.58542556, -0.65644884, -0.087699175, -0.43076077, -0.5710572, 0.6636643, -0.57122636, 0.19333375, -0.32752872, 0.3945517, -0.4714887, -0.16582781, -0.65677655, 0.30705708, -0.058605015, 0.55356425, -0.3966708, 0.61612076, -0.104949, -0.25026992, -0.4063139, 0.59430593, -0.2072208, 0.5581309, -0.34119853, -0.12464088, 0.6461111, 0.48652285, 0.3186174, 0.2211904, 0.34360164, -0.27322385, -0.038829565, -0.21223113, -0.3062798, -0.41992378, -0.30115128, -0.105315804, -0.60304487, -0.48973584, -0.010244191, -0.5717246, 0.04635799, 0.09993851, -0.26170453, -0.6077874, -0.18826526, -0.37365744, 0.06398094, -0.08144635, -0.5379327, -0.30083326, 0.1121304, -0.15862495, -0.37192824, -0.37637463, 0.19844979, 0.7028195, 0.6693097, 0.44438106, 0.39416617, 0.18745542, -0.094997406, 0.19920975, -0.5784471, -0.53019875, 0.15714324, 0.13756824, 0.23477143, 0.67883223, 0.56578, -0.21755436, 0.42961162, 0.6369639, -0.50966066, 0.33651274, 0.023927689, -0.2968846, -0.46360278, -0.51746583, 0.44259518, 0.09131241, 0.4118753, -0.13536263, -0.1495918, 0.34542412, -0.09916806, 0.1483882, -0.35112396, -0.41274408, 0.69064623, -0.015715122, -0.3871831, -0.29515025, 0.6695619, -0.552112, 0.49657196, -0.63113284, 0.2628351, -0.60202944};
double bf[] = {-0.6912547, -0.38726455};
double wg[] = {-0.25001281, 0.18647455, 0.4224219, 0.25550523, 0.34167612, -0.4745062, 0.7651541, 0.5586393, 0.40291372, -0.59456336, 0.32693955, -0.45651585, -0.26440364, -0.6908188, -0.69322664, -0.433188, -0.031978127, -0.45727438, 0.36567768, 0.37384376, 0.3221637, 0.59327954, 0.56281364, 0.29515272, -0.19163655, -0.42160267, -0.64273465, -0.7038992, -0.74489564, -0.59542096, -0.44836584, -0.43143466, 0.47991216, -0.24239501, -0.33577296, -0.1472678, -0.63096124, -0.03964293, 0.69780225, 0.3161856, -0.21481042, 0.52227515, 0.3385957, -0.23886506, -0.21128556, -0.019523636, 0.66031724, -0.49510357, 0.1478006, -0.23499726, -0.6240695, -0.04209163, -0.077177435, 0.6104268, -0.73874533, -0.12081992, 0.5932325, 0.54700357, 0.6091672, -0.6543139, 0.54724795, 0.4071577, -0.6022361, -0.16136868, -0.32352382, 0.19635822, -0.28648162, 0.20308478, -0.2059229, -0.025673965, -0.7250818, 0.2561899, -0.7406246, -0.06922005, 0.6500085, -0.62738544, 0.73007494, -0.15431337, 0.3897778, 0.17775907, -0.40596753, -0.12465219, 0.1921605, -0.15979642, 0.0708821, -0.08702082, -0.26256377, -0.51655823, -0.2321101, 0.35648602, -0.23039207, 0.7732969, 0.39419052, 0.7906535, 0.6758019, -0.36739704, -0.34656322, 0.33648193, 0.40461284, -0.14250198, -0.52240705, -0.44339558, -0.48285934, -0.54947716, 0.14277731, -0.54253393, 0.23848449, 0.40734205, -0.35612467, -0.20927176, -0.50636595, -0.2824503, -0.3054448, -0.47369927, 0.15632151, -0.24934284, 0.6767618, -0.039617267, -0.13437504, 0.277736, 0.26851326, -0.44667765, 0.5205609, 0.5214962, -0.38070422, -0.81345075, 0.4411761, -0.36629066, -0.20502217, -0.51865405, 0.08801317, 0.00267592, 0.02093157, 0.37816414, 0.5193014, -0.1835593, 0.55110234, 0.16924082, -0.1367097, -0.41264883, 0.2085914, -0.6210149, -0.17343633, 0.4923998, 0.6147667, -0.27211508, 0.2498035, -0.10613844, -0.6325599, -0.77298665, -0.7035214, -0.8270189, -0.06834006, 0.31143332, 0.6840753, 0.52104425, 0.49120536, 0.19176643, -0.35475186, 0.4616069, 0.35877043, -0.13968131, -0.6717462, -0.2098343, -0.21690731, 0.5665953, 0.4876736, -0.15065126, -0.58711594, -0.43078294, 0.826962, -0.28126228, -0.06514301, 0.76708555, -0.21599755, -0.37912598, -0.0055216434, 0.3863704, 0.2246745, -0.57516193, -0.52081174, -0.18783939, 0.16279812, 0.09631214, 0.20842525, -0.25653845, 0.3478172, -0.30108175, -0.43902707, 0.04935651, -0.6180482, 0.31244373, -0.36935672, -0.78022546, -0.055327024, -0.61801374, -0.032291416, 0.42655554, -0.19573492, -0.16690505, -0.51601523, -0.2757814, 0.20391747, -0.121916935, 0.05812877, -0.24599452, 0.5020201, 0.15082361, 0.15762883, -0.15739164, 0.33471256, 0.6787608, -0.40971676, 0.30640566, -0.75311744, 0.38797367, -0.13352539, -0.54192734, 0.4093099, 0.2891409, -0.5739807, 0.08153776, 0.48108205, -0.6010593, 0.15083744, 0.63983375, 0.15150306, -0.22718306, -0.3823086, 0.27673808, 0.6772112, 0.45218405, 0.5847103, 0.11478872, 0.59009343, 0.5817161, -0.35012302, 0.17216542, 0.04394595, -0.6092935, -0.3220047, -0.85640275, -0.73709583, 0.23097955, 0.18967232, 0.30217034, -0.5077816, 0.22342227, -0.09557852, -0.1297989, -0.54131365, -0.62474775, 0.6465018, -0.3517279, 0.07390726, -0.31713635, -0.23748039, 0.09593053, 0.45221236, 0.19175193, 0.5517033, -0.122793, 0.30637708, 0.26388654, 0.7473859, 0.4857951, 0.2699768, -0.3188993, 0.23431383, -0.6355878, -0.120269164, -0.025266431, -0.7208087, -0.37769908, -0.14771612, -0.1226921, -0.47107202, -0.6808609, 0.39453775, 0.46429965};
double bg[] = {0.25078517, 0.30743515};
double wo[] = {0.2321896, -0.14905775, -0.5257429, 0.25077474, -0.11360428, 0.014585326, -0.61631215, -0.006108128, -0.38702208, 0.36333242, 0.5630611, 0.3416235, 0.41796204, 0.6109617, 0.69713783, 0.58758324, 0.7826424, 0.5788109, 0.021424226, -0.08624036, 0.4871571, 0.30378982, 0.5401445, -0.26763284, 0.06211094, -0.36379611, 0.63991404, 0.05454793, -0.7033267, 0.4262895, 0.006676791, -0.63908815, 0.20687759, -0.11459755, 0.07812347, -0.3411332, -1.0163261, -0.0834723, -0.1717028, 0.28246278, 0.16152254, 0.19118479, 0.29581657, -0.5010681, 0.24037613, -0.7111168, 0.4476275, 0.31060526, -0.110106714, 0.127836, -0.21956086, -0.4028146, -0.5725204, 0.054169025, -0.6217456, -0.038183354, 0.6379839, 0.10219322, 0.37096012, 0.8326471, 0.1434192, 0.13041821, 0.625176, -0.14750564, -0.23882401, -0.7835451, -0.62752867, 0.36269632, 0.7340505, -0.13723531, -0.6019908, -0.35050657, 0.34329998, 0.69339347, 0.01482851, 0.5013589, -0.24622747, 0.5775873, -0.0058800657, -0.0063694324, -0.0037163103, -0.53305835, -0.080696195, 0.60907876, 0.61637235, 0.48352373, 0.33780748, 0.6260696, -0.3321755, 0.813377, 0.65951955, 0.5427651, 0.30997643, 0.706929, -0.09559591, -0.16585037, -0.6001008, -0.19983263, 0.1963515, 0.041600913, 0.226259, 0.3792144, 0.74691993, 0.6883307, -0.30647513, -0.031670544, 0.52169615, 0.30625272, 0.5927434, -0.6268009, -0.7091854, 0.0027097347, 0.054341007, 0.029471269, 0.42827904, 0.3106849, 0.008802173, -0.47579426, -0.48221433, -0.42839688, 0.31638816, 0.16652155, -0.644592, -0.09783166, -0.5856293, -0.04285125, -0.16933762, 0.24705496, -0.23510472, -0.16851522, -0.09286972, 0.005206943, -0.01835329, -0.6266899, -0.41509593, 0.5518321, 0.14546704, -0.26333615, -0.52342296, -0.5333127, 0.07471213, 0.306591, -0.72928315, -0.6879563, 0.5432265, 0.23165637, -0.3974893, 0.31257007, -0.060521536, 0.44191387, 0.22149633, -0.40683845, 0.1622987, -0.2628053, 0.33600542, 0.27685383, 0.3944175, -0.40908214, -0.15617472, -0.49635845, 0.45831206, 0.033087876, 0.66933, 0.2968985, 0.35966548, 0.043663494, -0.49789613, -0.36261073, -0.33641034, -0.3971715, 0.16295812, 0.07634853, 0.0026903262, -0.33577386, 0.21980388, 0.3016533, -0.1581047, -0.64664876, -0.6949876, 0.17200842, -0.7004911, -0.6053845, -0.341166, -0.4288609, 0.23878247, -0.23670763, -0.53874767, 0.45452508, 0.2074469, 0.7892329, -0.19191808, 0.6525035, 0.10273029, -0.4266584, 0.08740374, 0.20451239, -0.14810133, 0.27322778, 0.5801781, 0.12011768, 0.1925198, -0.11384303, -0.02964768, -0.68810135, -0.36984208, -0.4863026, 0.14383529, 0.062431894, -0.056640774, 0.58758044, 0.114464715, 0.19044788, -0.19985949, 0.74757886, 0.66338736, 0.054691646, 0.5984447, 0.08788517, -0.34640515, 0.6970471, -0.6105652, 0.3511564, -0.65142643, 0.32562616, -0.82353306, 0.12373927, -0.40066648, -0.6888839, -0.02697086, -0.109162144, 0.3388655, -0.7115092, 0.32123667, -0.21625255, -0.016537046, 0.060301375, -0.08772558, 0.10384055, 0.6712143, -0.048655324, 0.18364537, -0.16210373, -0.4003135, -0.21097909, 0.94760996, 0.91075814, 0.57290125, 0.51496583, -0.15599427, 0.71004045, 0.18894225, 0.8017909, -0.32598612, 0.48089364, 0.27327505, -0.09977197, -0.10117872, -0.27271152, 0.3198048, 0.080432706, 0.041969694, 0.030104714, 0.04326293, 0.6992697, 0.30785158, 0.5039929, 0.07951454, -0.25356695, -0.2752057, -0.2952365, -0.37170824, 0.275446, -0.6055725, -0.8587132, 0.38788146, -0.5718571, -0.14319809, -0.36939785, -0.05676914, -0.03972466};
double bo[] = {0.27432552, -0.072016455};
double whi[] = {0.24400437, -0.41075128, 0.40095168, 0.6100618};
double whf[] = {0.2564538, -0.16659379, -0.13012326, -0.5777576};
double whg[] = {0.35791832, 0.11005527, -0.5138813, -0.12492269};
double who[] = {0.5789754, -0.3112488, 0.37581974, 0.42929417};
double bhi[] = {-0.5488317, 0.20281497};
double bhf[] = {0.36516768, -0.68938};
double bhg[] = {-0.30831173, -0.27222103};
double bho[] = {0.43403378, 0.23745997};
double fc_w[] = {-1.3896562, -2.948311, -0.6429773, 2.7299592, 1.7284223, 1.0241151, 1.0475217, 1.2580489, 2.3800483, 0.12112902};
double fc_b[] = {0.24623616, 0.4152964, -0.6491849, -0.18527554, -1.1362385};


void lstm_init(LSTM_t* lstm)
{
    // 模型维度定义
    lstm->hidden_dim = 2;
    lstm->num_layers = 1;
    lstm->input_dim = 140;
    lstm->num_labels = 5;

    // LSTM参数初始化
    lstm->wi = wi;
    lstm->bi = bi;
    lstm->wf = wf;
    lstm->bf = bf;
    lstm->wg = wg;
    lstm->bg = bg;
    lstm->wo = wo;
    lstm->bo = bo;
    lstm->whi = whi;
    lstm->whf = whf;
    lstm->whg = whg;
    lstm->who = who;
    lstm->bhi = bhi;
    lstm->bhf = bhf;
    lstm->bhg = bhg;
    lstm->bho = bho;

    // 全连接层参数初始化
    lstm->fc_w = fc_w;
    lstm->fc_b = fc_b;
}


// 激活函数
double sigmoid(double x) {
    return 1.0 / (1.0 + exp(-x));
}

double tanh_activation(double x) {
    return tanh(x);
}

void softmax(double *input, int length) {
    double max = input[0];
    double sum = 0.0;

    // 找到最大值，用于数值稳定性
    for (int i = 1; i < length; i++) {
        if (input[i] > max) {
            max = input[i];
        }
    }

    // 计算指数的和
    for (int i = 0; i < length; i++) {
        input[i] = exp(input[i] - max); // 减去最大值以增加数值稳定性
        sum += input[i];
    }

    // 归一化
    for (int i = 0; i < length; i++) {
        input[i] /= sum;
    }
}

// 矩阵-向量乘法
void matrix_vector_multiply(double* matrix, double* vector, double* result, int rows, int cols) {
    for (int i = 0; i < rows; i++) {
        result[i] = 0;
        for (int j = 0; j < cols; j++) {
            result[i] += matrix[i * cols + j] * vector[j];
        }
    }
}

// 向量加法
void vector_add(double* vector1, double* vector2, int length) {
    for (int i = 0; i < length; i++) {
        vector1[i] += vector2[i];
    }
}

void matrix_multiply_and_add(double* input, 
                                double* w1, double* b1, double* w2, double* b2, 
                                double rows, double cols,
                                double* result)
{
    // 此处省略np.dot(hx, whi.T)
    matrix_vector_multiply(w1, input, result, rows, cols);
    vector_add(result, b1, rows);
    vector_add(result, b2, rows);
}


void calculate_i(   double* input, 
                    double* w, double* b, double* wh, double* bh, 
                    double rows, double cols,
                    double* result)
{
    matrix_multiply_and_add(input, w, b, wh, bh, rows, cols, result);

    for (int idx = 0; idx < rows; idx++) {
        result[idx] = sigmoid(result[idx]);
    }
}


void calculate_f(   double* input, 
                    double* w, double* b, double* wh, double* bh, 
                    double rows, double cols,
                    double* result)
{
    matrix_multiply_and_add(input, w, b, wh, bh, rows, cols, result);

    for (int idx = 0; idx < rows; idx++) {
        result[idx] = sigmoid(result[idx]);
    }
}


void calculate_g(   double* input, 
                    double* w, double* b, double* wh, double* bh, 
                    double rows, double cols,
                    double* result)
{
    matrix_multiply_and_add(input, w, b, wh, bh, rows, cols, result);

    for (int idx = 0; idx < rows; idx++) {
        result[idx] = tanh_activation(result[idx]);
    }
}


void calculate_o(   double* input, 
                    double* w, double* b, double* wh, double* bh, 
                    double rows, double cols,
                    double* result)
{
    matrix_multiply_and_add(input, w, b, wh, bh, rows, cols, result);

    for (int idx = 0; idx < rows; idx++) {
        result[idx] = sigmoid(result[idx]);
    }
}

void fullconncetlayer_forward(double* input, LSTM_t* lstm, double* result)
{
    matrix_vector_multiply(lstm->fc_w, input, result, lstm->num_labels, lstm->hidden_dim);
    vector_add(result, lstm->fc_b, lstm->num_labels);
}


// LSTM前向步骤
/*
    i = sigmoid(np.dot(input, wi.T) + bi + np.dot(hx, whi.T) + bhi)
    f = sigmoid(np.dot(input, wf.T) + bf + np.dot(hx, whf.T) + bhf)
    g = tanh(np.dot(input, wg.T) + bg + np.dot(hx, whg.T) + bhg)
    o = sigmoid(np.dot(input, wo.T) + bo + np.dot(hx, who.T) + bho)
    c_t = f * c_t-1 + i*g
    h_t = o * tanh(c_t)
    result = fullconnect(ht)
*/
void lstm_forward_step(double* input, LSTM_t* lstm) {
    double result_i[lstm->hidden_dim], f[lstm->hidden_dim], result_g[lstm->hidden_dim], result_o[lstm->hidden_dim];
    double hx[lstm->hidden_dim], cx[lstm->hidden_dim];
    double result_fc[lstm->num_labels];

    // 输入门
    calculate_i(input, lstm->wi,lstm->bi,lstm->whi, lstm->bhi, lstm->hidden_dim, lstm->input_dim, result_i);
    // calculate_i(input, lstm->wf, lstm->bf, lstm->whf, lstm->bhf, lstm->hidden_dim, lstm->input_dim, result_f);
    calculate_g(input, lstm->wg, lstm->bg, lstm->whg, lstm->bhg, lstm->hidden_dim, lstm->input_dim, result_g);
    calculate_o(input, lstm->wo, lstm->bo, lstm->who, lstm->bho, lstm->hidden_dim, lstm->input_dim, result_o);

    for (int idx = 0; idx < lstm->hidden_dim; idx++) {
        cx[idx] = result_i[idx] * result_g[idx]; // 简化的更新
    }

    for (int idx = 0; idx < lstm->hidden_dim; idx++) {
        hx[idx] = result_o[idx] * tanh_activation(cx[idx]);
    }

    // 最后的全连接层
    fullconncetlayer_forward(hx, lstm, result_fc);

    for(int idx=0; idx<lstm->num_labels; idx++)
    {
        // std::cout << result_fc[idx] << ", "; // << std::endl;
        printf("%f, ", result_fc[idx]); //<< std::endl;
    }
    printf("\n");


    // 寻找最大值（如果需要概率的话，这里可以加一个softmax）
    softmax(result_fc, lstm->num_labels);

    for(int idx=0; idx<lstm->num_labels; idx++)
    {
       printf("%f, ", result_fc[idx]); //<< std::endl;
    }
}

int main() {

    printf("It's a LSTM Demo !\n");

    // 定义一个LSTM模型
    LSTM_t lstm;

    // 模型初始化
    lstm_init((LSTM_t*)&lstm);

    double input[] = {-0.9653828, -3.4292935, -4.4667261, -4.5022782, -3.8730168, -2.5937239, -1.7200481, -1.5611601, -0.75637187, -0.11362749, -0.17726887, 0.034054011, -0.076005714, -0.26941959, -0.13121241, 0.07436577, -0.19763482, -0.33973715, -0.15893583, -0.24544628, -0.33026761, -0.32636939, -0.058120115, -0.12237561, -0.49445641, -0.38424342, -0.28438239, -0.35577216, -0.49600543, -0.41810702, -0.24830038, -0.36598899, -0.53950957, -0.86199884, -0.71441154, -0.54776947, -0.55518661, -0.37425822, -0.45429818, -0.49918627, -0.52651181, -0.25535826, -0.070875198, -0.12483854, -0.12623492, 0.13251541, -0.057132071, 0.15032902, 0.15771871, -0.12583959, 0.21195017, 0.14869865, 0.047337855, 0.10101258, 0.015139442, 0.15838554, 0.15228459, 0.26926043, 0.3934134, 0.14259107, 0.088508603, 0.17900153, 0.20968722, 0.052655902, 0.017015221, 0.21482418, 0.21359426, 0.27956951, 0.35419948, 0.37402029, 0.49685464, 0.62647376, 0.4365944, 0.24408206, 0.5454452, 0.56442223, 0.49450567, 0.57149993, 0.58342424, 0.75548752, 0.39414383, 0.2413328, 0.40905794, 0.39375897, 0.51068627, 0.35726761, 0.10802934, 0.27038174, 0.40870047, 0.40897395, 0.45677858, 0.4137597, 0.46611063, 0.2156728, 0.20833047, 0.36937952, 0.68345149, 1.083104, 1.2298179, 1.3346387, 1.5985869, 2.0025378, 2.0581566, 1.8666665, 1.8558982, 1.9671186, 1.6298517, 1.3282007, 1.2914582, 0.94858227, 0.44374288, -0.0097391081, -0.28455311, -0.41301779, -0.4150061, -0.29367072, -0.46542718, -0.3869822, -0.50380411, -0.5674997, -0.32881587, -0.54360014, -0.71978864, -0.72874794, -0.38091481, -0.37958329, -0.44115329, -0.28893242, 0.21377353, 0.83825722, 1.3436598, 1.3138883, 1.2050952, 1.0583597, 0.85243748, -0.024256427, -0.14111718, 0.30815197, 0.5003428, -1.4673678};
   
    // // 调用LSTM前向步骤
    lstm_forward_step(input, &lstm);

    return 0;
}


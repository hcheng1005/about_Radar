#include <math.h>
#include <stdio.h>

#include "lstm.h"

// 模型参数
double wi0[] = {-0.2576877, -0.55972564, -0.119454585, 0.07881378, -0.0808577, -0.50654876, 0.36338612, -0.819878, -0.493405, -0.60216266, 0.2118587, 0.3194868, -0.11876891, 0.52128816, 0.51077735, 0.30193037, -0.028672908, 0.09094162, -0.5136143, 0.55179805, 0.78823584, -0.36339548, 0.7810627, -0.40363264, 0.5755925, -0.34557065, -0.27412292, 0.22334816, 0.6537155, 0.77915347, 0.44345137, 0.37185332, -0.12295613, -0.06656843, 0.3383461, -0.3806997, 0.32996094, -0.34063795, -0.072927624, -0.07641941, -0.18036838, -0.22550495, -0.2388197, 0.30822513, 0.057535753, -0.5486771, 0.2187293, -0.7044734, -0.43094438, 0.24157938, -0.24260011, -0.5252231, 0.22686729, 0.660264, 0.6836323, 0.42457977, 0.3047091, 0.27627373, 0.7097632, 0.3792636, -0.49941516, 0.57699674, 0.27959383, -0.5943158, 0.40434012, 0.15526341, -0.42706624, -0.6876317, -0.69213283, 0.20792447, 0.2161336, 0.34923312, -0.62438804, -0.08249284, -0.43049204, 0.28359213, 0.6371518, 0.3655741, -0.6775022, 0.28863856, -0.58016413, 0.23344226, -0.5027815, -0.5768804, -0.25165647, -0.28015506, 0.61926806, 0.21116364, 0.3988642, -0.65923524, -0.39331174, 0.09463201, -0.4966897, -0.12031975, -0.42815092, -0.81649584, 0.26593527, 0.23783407, -0.5367654, -0.19500113, -0.3766053, -0.44032836, -0.55277175, -0.16268624, 0.08640941, -0.17416394, 0.77669674, 0.5250126, 0.6282021, 0.75813335, 0.40721565, -0.055908963, 0.17284718, -0.3840542, 0.6440669, -0.1412825, -0.39600283, 0.7280193, 0.483778, 0.6844896, 0.50096726, 0.07967382, 0.070127435, -0.3283135, 0.5674964, -0.33624053, -0.82732207, 0.2352094, 0.44197273, 0.4979887, -0.06797471, -0.11326651, 1.0347999, -0.37226847, -0.92540187, -0.07641459, 0.40947804, 0.21677364, 0.7715452, -0.73226064, 0.33688882, 0.47348762, -0.5455688, 0.23830655, -0.25854596, 0.6154801, -0.21463618, 0.41026023, 0.13913892, 0.3269961, 0.51148725, 0.37087703, -0.23167478, -0.023436947, 0.1684831, -0.4772039, 0.57433695, -0.21698603, -0.09923977, -0.65997374, -0.6504511, -0.17198308, -0.2930939, -0.014640797, 0.23397431, -0.49010676, 0.34721592, -0.4828684, -0.65286005, -0.53340185, 0.19673982, -0.056491617, -0.53115356, -0.2682482, 0.09179976, -0.49542058, 0.31575778, -0.32077518, 0.20378718, -0.2812889, -0.065310046, -0.18135071, 0.41878, -0.6915579, -0.076633155, 0.74499667, -0.25042856, -0.006079524, -0.27013895, 0.27182087, 0.16067313, -0.526429, -0.5223125, 0.24347049, 0.16380392, 0.06487143, 0.34464973, 0.08994686, 0.32946607, -0.02342793, 0.05872302, -0.046976287, -0.026611986, 0.12263117, 0.40887246, 0.040037572, 0.6983942, 0.46475837, -0.008359582, 0.4219412, 0.89251655, -0.029698003, 0.112108, 0.98727494, 1.1725665, -0.11397449, 0.70175415, -0.25102675, 0.6556505, -0.1496227, -0.35988352, 0.64492613, -0.39917743, 0.26292658, 0.26770234, -0.76533943, -0.45440155, -0.42872792, 0.33559224, 0.20255932, 0.16451937, -0.25240982, 0.09277276, -0.05433403, -0.5124121, -0.6666601, 0.12409549, -0.4177038, -0.37163523, -0.079323575, 0.7023388, 0.34043145, 0.85861284, 0.41681647, 0.4801485, 0.74180573, 0.55550593, -0.4760463, 0.09475359, -0.11774483, 0.62593365, 0.075071625, -0.57121754, -0.43092212, -0.16675, -0.17000133, 0.043012597, -0.61110306, -0.39950305, 0.4045333, -0.0773177, -0.25280365, -0.2670536, 0.95103765, 0.54718137, 0.8678731, 0.6213922, -0.19299835, -0.21955258, -0.06507713, -0.26295173, -0.24457608, -0.36837864, -0.8507707, 0.2694148, -0.19317368, -0.6259801, -0.1424485, -0.68511605, -0.11360107};
double bi0[] = {0.822232, 0.8416011};
double wf0[] = {-0.6749041, -0.024933755, -0.531984, 0.50648767, -0.52992594, 0.08409536, -0.27204484, -0.33827287, -0.41832542, -0.38072622, -0.089235306, -0.124581754, 0.5585901, 0.53487617, -0.3912265, -0.5619468, 0.23656267, 0.20328206, 0.09263837, -0.38009158, -0.2310673, 0.4681452, 0.0020454526, 0.4980101, -0.6136024, -0.5111152, -0.24167585, -0.4638424, 0.6507506, 0.052131593, 0.11163306, -0.3841857, 0.64667004, 0.6343879, 0.20344657, -0.0991717, 0.55839425, -0.5865567, 0.088867724, -0.6839223, -0.6006943, -0.4180444, -0.3968994, -0.149894, -0.20807451, -0.6834898, 0.33162218, 0.6053228, -0.6011292, 0.014649808, 0.34008843, -0.00880295, 0.25724494, -0.40703848, 0.15419704, 0.6246919, -0.6210183, 0.19719481, 0.07980245, 0.08603823, -0.47939318, -0.3355325, 0.40186864, 0.10694671, -0.41764128, 0.37407213, -0.074423075, 0.47820503, 0.6260827, 0.27580756, -0.15334868, -0.6485841, -0.12361747, -0.068929255, -0.70120114, 0.50148684, 0.4824888, 0.15538818, 0.6126254, -0.12920654, -0.25976947, -0.55526376, 0.34206623, -0.42121905, -0.22235784, -0.25233477, 0.17745113, 0.19995677, 0.6332875, -0.58786136, 0.6990207, 0.60590976, -0.20690024, 0.6967972, 0.46866578, 0.14843571, -0.15694678, -0.47530645, -0.57265097, -0.11171967, -0.08974379, 0.16474336, -0.4669231, -0.21369985, 0.6086586, 0.3355053, 0.06996757, 0.6282094, 0.26103568, 0.13061315, -0.5009438, -0.6983185, -0.3987623, -0.7041771, 0.01958406, -0.12043512, 0.19542778, 0.58452505, -0.13951617, -0.1692419, -0.1641947, -0.7053214, -0.42962196, 0.050273538, 0.58585197, 0.2445845, 0.28732485, -0.35266003, 0.27131015, 0.31956917, -0.4142445, -0.22274122, -0.5006819, -0.62634623, -0.41292617, -0.7019421, 0.012417734, 0.080195904, 0.6080536, -0.27035996, 0.35190195, 0.46057183, -0.21563482, -0.64250594, -0.03847778, -0.045502305, 0.49921066, 0.34586662, 0.0691815, -0.6169926, -0.14621371, 0.45053738, -0.3204699, 0.24351102, -0.19812977, 0.36237198, -0.33191267, 0.20671326, -0.52099067, -0.44580188, 0.3409062, 0.34304875, 0.70106167, 0.58045644, -0.08993167, -0.44635206, -0.6769344, 0.62706774, 0.6018024, 0.12212181, 0.22747713, -0.16416019, -0.6522511, 0.39892763, -0.3750615, -0.19657385, -0.30087632, -0.6144521, -0.42482987, 0.52190405, 0.70649964, -0.4432165, -0.34528056, -0.6648452, 0.6186848, 0.69993216, -0.18744057, -0.03867817, -0.13725054, -0.18033075, -0.2770342, 0.054655194, -0.61855054, -0.1295945, -0.07589722, -0.6107735, -0.15268946, 0.5234752, -0.67141557, 0.3151955, -0.33609143, 0.45206112, 0.31631523, 0.4828114, 0.3922717, 0.155447, -0.65628785, 0.3628195, 0.0131616, -0.06359923, 0.22140801, 0.31054753, -0.5666036, -0.24221829, 0.30927938, -0.114561796, 0.31400234, 0.33801776, -0.11185336, 0.2876724, -0.4716499, -0.096075416, 0.18009138, 0.43151122, 0.30923754, -0.6111516, 0.6064251, 0.31065077, 0.4912097, 0.030361176, -0.1980632, 0.6649658, -0.654416, 0.6140495, 0.15429354, 0.1746031, 0.43998235, 0.5731818, -0.4630524, -0.15462476, 0.4511327, -0.07891077, -0.11077708, 0.6437436, -0.081576645, 0.36568063, -0.6117684, -0.6296008, 0.41485268, 0.5475641, 0.3205753, -0.32961878, -0.30765978, 0.4582898, 0.19964594, 0.61970705, -0.39709672, 0.23094535, 0.0400573, -0.13393164, 0.65123385, 0.019996047, 0.39301187, -0.6343111, -0.19558781, 0.16734445, -0.48225132, -0.021542609, 0.5160168, -0.34640443, -0.05431062, 0.34716886, -0.25850683, -0.064498305, 0.28257656, 0.6462454, -0.47428378, 0.5424071, -0.13620603, 0.15415907};
double bf0[] = {0.0018720031, 0.45184106};
double wg0[] = {0.29773572, -0.06727255, 0.049758695, -0.07837706, 0.095878206, 0.20656717, -0.31287318, 0.37914082, 0.29169473, 0.09724668, 0.6026514, -0.3956055, 0.23171239, -0.45131388, -0.59167653, 0.57900584, 0.43596125, -0.68921584, -0.13676882, -0.08173452, -0.53172386, -0.4714648, 0.6093592, -0.4447914, -0.23200713, 0.27907452, 0.60320395, -0.44652456, 0.4357488, -0.5666876, -0.18594086, -0.62868965, 0.5452771, -0.6550501, -0.15095326, -0.37278357, 0.10944031, 0.36740232, 0.020884989, -0.41186213, -0.4412963, 0.15530735, -0.20833182, 0.64922094, -0.33539402, 0.20203832, 0.31695276, 0.5820143, -0.037568565, 0.089577764, 0.2267997, -0.24492677, 0.09411656, 0.20534194, -0.18975323, -0.30194423, 0.41392836, -0.06368767, -0.20236006, -0.053213436, 0.07208525, 0.12049514, -0.5256176, -0.28939107, -0.2283263, 0.31833798, -0.08395918, 0.6726709, 0.6439164, 0.37690052, 0.062129527, -0.40280133, -0.2367714, -0.30790704, 0.07532453, -0.52619106, -0.37196964, 0.39765057, 0.43540418, 0.15553981, -0.00087309093, -0.055779062, 0.08537889, -0.050917834, -0.5148372, 0.15880965, -0.5442455, 0.02050295, -0.3437667, -0.4084909, -0.044087745, -0.46428576, -0.61537087, 0.225079, 0.36297172, 0.5991882, 0.05952218, 0.15282932, -0.07100696, 0.564884, 0.50326896, -0.335854, 0.8732302, 0.5858541, 0.6148929, 0.4034204, 0.5059475, 0.7189158, -0.32669505, 0.13073595, -0.42340797, 0.41170245, -0.36001995, -0.37478969, 0.2560201, -0.5062614, 0.32885104, -0.18738726, 0.35943884, -0.49710435, -0.15708476, -0.53440464, -0.5711025, 0.47665933, -0.8555306, -0.54588544, -0.071925424, -0.00048576965, -0.39460608, -0.6559636, -0.47016305, 0.074912734, -0.25273404, 0.18199383, 0.9140686, 0.39528248, -0.19075903, -0.26484093, 0.4954997, -0.28145373, 0.3260967, 0.51098424, -0.7883151, 0.12733117, 0.1645891, 0.07459424, 0.07381842, 0.35711798, -0.14383583, 0.25742617, 0.40942517, 0.78420734, 0.3952704, -0.1789569, 0.83203053, 0.21933295, -0.29349425, -0.63681066, -0.014016432, -0.6538357, 0.0262302, -0.70284194, 0.36555588, 0.4492734, -0.41362283, -0.36228362, -0.21115197, -0.72431576, 0.4306199, 0.39313927, -0.5447667, -0.50288546, -0.8101561, -0.49721372, -0.060673814, -0.6212185, -0.030726722, -0.16264348, 0.37821522, -0.17209834, -0.7706215, -0.07094632, -0.022209335, -0.43190846, -0.6166119, 0.6097106, 0.2801082, 0.63536227, -0.04463082, 0.8563116, 0.5815269, 0.8447796, -0.18165025, 0.52513736, 0.43062246, 0.2980174, 0.3625565, -0.20791613, -0.48546356, 0.3810916, -0.1692808, 0.37497923, -0.18153493, 0.43403795, -0.66298354, 0.36580256, 0.47836208, -0.54001373, -0.31896174, -0.59879297, -0.27583888, 0.12297802, 0.2892021, 0.17544217, -0.1444368, 0.7486184, -0.074389756, 0.17226563, 0.55886877, 0.0757315, 0.054217912, 0.3115271, 0.77223456, 0.1680243, 0.5001874, 0.07378281, 0.10991379, 0.19847132, -0.09474012, -0.16284567, -0.732681, 0.21110252, -0.30546543, 0.5183573, -0.057349134, -0.07258359, 0.28717116, -0.27490965, 0.047640968, -0.2732263, 0.3042138, 0.17221087, -0.2347433, 0.31520805, 0.28426465, 0.6034537, -0.40506142, 0.24525021, -0.60438806, 0.34510538, 0.37243652, -0.724617, -0.06540461, -0.88415635, 0.32939255, -0.092936225, 0.12142291, 0.53857756, -0.26859453, -0.2535967, -0.13098162, -0.09828081, -0.3390315, 0.5539133, 0.09868091, 0.073981166, 0.3250293, -0.004527485, -0.25960386, -0.51909953, 0.58622366, 0.04659489, 0.37608528, -0.37489438, 0.55725235, -0.24529786, -0.13749461, 0.05906016, 0.38685933, -0.44807312};
double bg0[] = {0.38522148, 0.16337955};
double wo0[] = {0.26351976, -0.46674693, -0.34525606, 0.21073121, -0.25251126, -0.16706574, -0.8626646, 0.043968644, 0.078181006, 0.33811834, -0.19060667, 0.36009926, -0.47681135, -0.15926372, -0.3132135, 0.5471493, -0.66425765, -0.36747885, -0.1591203, 0.06674342, 0.5713473, 0.14311802, -0.6811271, -0.12171139, 0.21453707, -0.9062305, 0.30244136, -0.41806844, -0.209488, -0.43853348, -0.14134431, -0.8863452, -0.99251944, -0.48361266, -0.32529458, -0.19937338, 0.0034943454, -0.61484957, -0.49043807, -0.37786922, -1.0673553, -0.4091742, 0.023960887, 0.0607714, 0.1752723, 0.2721071, 0.2659484, 0.7703736, 0.060922235, -0.13931707, -0.22792776, 0.38860345, 0.7024164, 0.48858574, 0.004573471, 0.3115423, -0.1002695, 0.8656869, -0.27663714, 0.3507381, -0.04218201, 0.01096455, -0.66011846, 0.51437104, -0.16455905, 0.5821949, -0.6161916, 0.6455781, -0.38855085, -0.43821603, -0.12587309, 0.72199595, -0.30984038, -0.05351005, 0.303909, 0.1312175, -0.121277496, 0.20394799, -0.18188773, 0.9186186, -0.13884115, 0.9823519, 0.33848804, 0.6232918, -0.21034741, -0.20537877, -0.22558384, 0.3391931, 0.7839528, 0.07617561, 0.37054178, 0.23451395, 0.39370453, 0.21119231, -0.17183895, -0.39240336, -0.48030195, -0.45052448, -0.4868567, -0.3989346, -0.16061792, 0.021196038, 0.43388587, 0.67590827, -0.37710065, 0.016147885, -0.4068215, 0.1754089, 0.62854403, 0.6793865, -0.19158341, -0.22909923, -0.59538454, -0.85433805, -0.65771145, -0.8043373, -0.72760516, -0.8303886, -0.7647431, -0.13328321, 0.48852286, 0.5494217, -0.4955536, 0.12864672, -0.04926811, 0.7638236, 0.6279396, 0.34868413, 0.25126576, 0.28578535, 0.425305, 0.05267669, 0.41299725, 0.023323886, -0.6590647, 0.03426524, 0.29596445, -0.53751135, 0.43122545, -0.5595116, 0.91200846, -0.3911852, -0.6006058, -0.25482506, -0.33360842, -0.886809, -0.692692, -0.75360554, 0.55954254, 0.3388414, -0.38365448, -0.046810523, 0.24656622, -0.13821036, 0.5571819, -0.4000568, -0.15180552, 0.6055886, 0.604938, 0.4265287, 0.083493225, 0.87979877, 0.13570446, 0.5063132, 0.23247759, 0.65210664, 0.7293613, -0.083651304, -0.14889447, 0.11986605, -0.35256803, -0.20831113, -0.5513587, 0.6129212, 0.75043905, 0.39453065, -0.118748374, 0.34786686, -0.057406146, -0.22949195, -0.271121, 0.69815737, -0.24183379, 0.23128524, 0.3464, 0.21369159, 0.30281729, 0.18684176, -0.3843374, 0.3441265, 0.45715672, -0.32472336, 0.17431085, -0.4504544, -0.08938866, -0.6661116, 0.06996364, 0.47871006, 0.44778514, -0.7104732, 0.6163458, 0.06361019, 0.30097774, -0.55928445, -0.27714452, -0.097983725, 0.610573, 0.00021499692, 0.07692123, -0.16868076, -0.20883204, -0.43099192, -0.034966983, 0.7474782, -0.099695615, -0.3929001, 0.2989335, 0.010643304, 0.18701799, 0.46676803, 0.2665902, -0.20245561, 0.66238964, -0.5985041, -0.7231397, 0.34195706, -0.4403611, -0.7687347, -0.6079116, -0.72732025, -0.81937325, 0.23156492, -0.71387273, -0.30578655, -0.55809164, 0.5400828, 0.45777473, 0.6012058, -0.28626803, -0.5164461, 0.69259673, -0.41370147, -0.33045256, 0.649659, 0.1441225, -0.08354328, 0.53342074, 0.84455264, 0.12106983, -0.020312652, 0.44706216, -0.30655453, 0.8867504, 0.3450249, -0.10464619, -0.37411615, -0.39385933, 0.24387123, 0.43079928, 0.63342613, 0.2620951, 0.7624177, 0.5108759, 0.7220503, -0.5171211, 0.6634249, -0.38729873, -0.7688846, 0.29768506, -0.3253518, 0.53266895, -0.034591287, 0.36809695, 0.2076703, 0.028173206, -0.7766086, -0.7250008, -0.4587224, 0.018909914, 0.007422506};
double bo0[] = {0.021966089, -0.41151044};
double whi0[] = {0.13144499, 0.705604, 0.45354885, 0.60092026};
double whf0[] = {0.69416744, -0.4550038, 0.10244179, -0.6402354};
double whg0[] = {-0.54216295, -0.38344687, 0.16490382, -0.023144662};
double who0[] = {0.39849848, 0.5245883, -0.36870265, -0.26793602};
double bhi0[] = {0.3852511, 0.14331032};
double bhf0[] = {0.34670693, 0.2430135};
double bhg0[] = {-0.74865735, -0.071878344};
double bho0[] = {0.23711745, 0.55069464};
double fc_w[] = {3.0282009, 2.598251, -0.93924576, -2.249625, -1.4841264, 1.6889488, -2.141541, 0.30876824, -0.85435575, 1.4197584};
double fc_b[] = {0.7183826, 0.9638936, -0.7987581, -0.5352953, -1.7745615};



void lstm_init(LSTM_t* lstm)
{
    // 模型维度定义
    lstm->hidden_dim = 2;
    lstm->num_layers = 1;
    lstm->input_dim = 140;
    lstm->num_labels = 5;

    // LSTM参数初始化
    lstm->wi = wi0;
    lstm->bi = bi0;
    lstm->wf = wf0;
    lstm->bf = bf0;
    lstm->wg = wg0;
    lstm->bg = bg0;
    lstm->wo = wo0;
    lstm->bo = bo0;
    lstm->whi = whi0;
    lstm->whf = whf0;
    lstm->whg = whg0;
    lstm->who = who0;
    lstm->bhi = bhi0;
    lstm->bhf = bhf0;
    lstm->bhg = bhg0;
    lstm->bho = bho0;

    // 全连接层参数初始化
    lstm->fc_w = fc_w;
    lstm->fc_b = fc_b;
}


// 激活函数
double sigmoid(double x) {
    return 1.0 / (1.0 + exp(-x));
}

double tanh_activation(double x) {
    return tanh(x);
}

void softmax(double *input, int length) {
    double max = input[0];
    double sum = 0.0;

    // 找到最大值，用于数值稳定性
    for (int i = 1; i < length; i++) {
        if (input[i] > max) {
            max = input[i];
        }
    }

    // 计算指数的和
    for (int i = 0; i < length; i++) {
        input[i] = exp(input[i] - max); // 减去最大值以增加数值稳定性
        sum += input[i];
    }

    // 归一化
    for (int i = 0; i < length; i++) {
        input[i] /= sum;
    }
}

// 矩阵-向量乘法
void matrix_vector_multiply(double* matrix, double* vector, double* result, int rows, int cols) {
    for (int i = 0; i < rows; i++) {
        result[i] = 0;
        for (int j = 0; j < cols; j++) {
            result[i] += matrix[i * cols + j] * vector[j];
        }
    }
}

// 向量加法
void vector_add(double* vector1, double* vector2, int length) {
    for (int i = 0; i < length; i++) {
        vector1[i] += vector2[i];
    }
}

void matrix_multiply_and_add(double* input, 
                                double* w1, double* b1, double* w2, double* b2, 
                                double rows, double cols,
                                double* result)
{
    // 此处省略np.dot(hx, whi.T)
    matrix_vector_multiply(w1, input, result, rows, cols);
    vector_add(result, b1, rows);
    vector_add(result, b2, rows);
}


void calculate_i(   double* input, 
                    double* w, double* b, double* wh, double* bh, 
                    double rows, double cols,
                    double* result)
{
    matrix_multiply_and_add(input, w, b, wh, bh, rows, cols, result);

    for (int idx = 0; idx < rows; idx++) {
        result[idx] = sigmoid(result[idx]);
    }
}


void calculate_f(   double* input, 
                    double* w, double* b, double* wh, double* bh, 
                    double rows, double cols,
                    double* result)
{
    matrix_multiply_and_add(input, w, b, wh, bh, rows, cols, result);

    for (int idx = 0; idx < rows; idx++) {
        result[idx] = sigmoid(result[idx]);
    }
}


void calculate_g(   double* input, 
                    double* w, double* b, double* wh, double* bh, 
                    double rows, double cols,
                    double* result)
{
    matrix_multiply_and_add(input, w, b, wh, bh, rows, cols, result);

    for (int idx = 0; idx < rows; idx++) {
        result[idx] = tanh_activation(result[idx]);
    }
}


void calculate_o(   double* input, 
                    double* w, double* b, double* wh, double* bh, 
                    double rows, double cols,
                    double* result)
{
    matrix_multiply_and_add(input, w, b, wh, bh, rows, cols, result);

    for (int idx = 0; idx < rows; idx++) {
        result[idx] = sigmoid(result[idx]);
    }
}

void fullconncetlayer_forward(double* input, LSTM_t* lstm, double* result)
{
    matrix_vector_multiply(lstm->fc_w, input, result, lstm->num_labels, lstm->hidden_dim);
    vector_add(result, lstm->fc_b, lstm->num_labels);
}


// LSTM前向步骤
/*
    i = sigmoid(np.dot(input, wi.T) + bi + np.dot(hx, whi.T) + bhi)
    f = sigmoid(np.dot(input, wf.T) + bf + np.dot(hx, whf.T) + bhf)
    g = tanh(np.dot(input, wg.T) + bg + np.dot(hx, whg.T) + bhg)
    o = sigmoid(np.dot(input, wo.T) + bo + np.dot(hx, who.T) + bho)
    c_t = f * c_t-1 + i*g
    h_t = o * tanh(c_t)
    result = fullconnect(ht)
*/
void lstm_forward_step(double* input, LSTM_t* lstm) {
    double result_i[lstm->hidden_dim], f[lstm->hidden_dim], result_g[lstm->hidden_dim], result_o[lstm->hidden_dim];
    double hx[lstm->hidden_dim], cx[lstm->hidden_dim];
    double result_fc[lstm->num_labels];

    // 输入门
    calculate_i(input, lstm->wi,lstm->bi,lstm->whi, lstm->bhi, lstm->hidden_dim, lstm->input_dim, result_i);
    // calculate_i(input, lstm->wf, lstm->bf, lstm->whf, lstm->bhf, lstm->hidden_dim, lstm->input_dim, result_f);
    calculate_g(input, lstm->wg, lstm->bg, lstm->whg, lstm->bhg, lstm->hidden_dim, lstm->input_dim, result_g);
    calculate_o(input, lstm->wo, lstm->bo, lstm->who, lstm->bho, lstm->hidden_dim, lstm->input_dim, result_o);

    for (int idx = 0; idx < lstm->hidden_dim; idx++) {
        cx[idx] = result_i[idx] * result_g[idx]; // 简化的更新
    }

    for (int idx = 0; idx < lstm->hidden_dim; idx++) {
        hx[idx] = result_o[idx] * tanh_activation(cx[idx]);
    }

    // 最后的全连接层
    fullconncetlayer_forward(hx, lstm, result_fc);

    for(int idx=0; idx<lstm->num_labels; idx++)
    {
        // std::cout << result_fc[idx] << ", "; // << std::endl;
        printf("%f, ", result_fc[idx]); //<< std::endl;
    }
    printf("\n");


    // 寻找最大值（如果需要概率的话，这里可以加一个softmax）
    softmax(result_fc, lstm->num_labels);

    for(int idx=0; idx<lstm->num_labels; idx++)
    {
       printf("%f, ", result_fc[idx]); //<< std::endl;
    }
}

int main() {

    printf("It's a LSTM Demo !\n");

    // 定义一个LSTM模型
    LSTM_t lstm;

    // 模型初始化
    lstm_init((LSTM_t*)&lstm);

    double input[] = {-0.9653828, -3.4292935, -4.4667261, -4.5022782, -3.8730168, -2.5937239, -1.7200481, -1.5611601, -0.75637187, -0.11362749, -0.17726887, 0.034054011, -0.076005714, -0.26941959, -0.13121241, 0.07436577, -0.19763482, -0.33973715, -0.15893583, -0.24544628, -0.33026761, -0.32636939, -0.058120115, -0.12237561, -0.49445641, -0.38424342, -0.28438239, -0.35577216, -0.49600543, -0.41810702, -0.24830038, -0.36598899, -0.53950957, -0.86199884, -0.71441154, -0.54776947, -0.55518661, -0.37425822, -0.45429818, -0.49918627, -0.52651181, -0.25535826, -0.070875198, -0.12483854, -0.12623492, 0.13251541, -0.057132071, 0.15032902, 0.15771871, -0.12583959, 0.21195017, 0.14869865, 0.047337855, 0.10101258, 0.015139442, 0.15838554, 0.15228459, 0.26926043, 0.3934134, 0.14259107, 0.088508603, 0.17900153, 0.20968722, 0.052655902, 0.017015221, 0.21482418, 0.21359426, 0.27956951, 0.35419948, 0.37402029, 0.49685464, 0.62647376, 0.4365944, 0.24408206, 0.5454452, 0.56442223, 0.49450567, 0.57149993, 0.58342424, 0.75548752, 0.39414383, 0.2413328, 0.40905794, 0.39375897, 0.51068627, 0.35726761, 0.10802934, 0.27038174, 0.40870047, 0.40897395, 0.45677858, 0.4137597, 0.46611063, 0.2156728, 0.20833047, 0.36937952, 0.68345149, 1.083104, 1.2298179, 1.3346387, 1.5985869, 2.0025378, 2.0581566, 1.8666665, 1.8558982, 1.9671186, 1.6298517, 1.3282007, 1.2914582, 0.94858227, 0.44374288, -0.0097391081, -0.28455311, -0.41301779, -0.4150061, -0.29367072, -0.46542718, -0.3869822, -0.50380411, -0.5674997, -0.32881587, -0.54360014, -0.71978864, -0.72874794, -0.38091481, -0.37958329, -0.44115329, -0.28893242, 0.21377353, 0.83825722, 1.3436598, 1.3138883, 1.2050952, 1.0583597, 0.85243748, -0.024256427, -0.14111718, 0.30815197, 0.5003428, -1.4673678};
   
    // // 调用LSTM前向步骤
    lstm_forward_step(input, &lstm);

    return 0;
}


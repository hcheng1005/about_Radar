#include <math.h>
#include <stdio.h>
#include <float.h> // For FLT_MIN

#include <stdlib.h>
#include <string.h>

#include "cnn.h"


float conv1_weight[] = {-0.4110592, -0.4754439, -0.14983568, -0.35083222, 0.007047881, 0.015510349, 0.044858392, -0.20810932, 0.17433071, -0.4063282, -0.08695585, -0.4083461, 0.12602282, -0.20751677, -0.47252354, -0.032917403, -0.27606285, -0.39759642};
float conv1_bias[] = {-0.07097214, -0.10497704};
float conv2_weight[] = {0.28173846, 0.07033281, 0.27035025, -0.169582, -0.20419936, 0.055261392, 0.05958658, -0.18273793, -0.019606208, 0.27554762, 0.26874095, 0.19213295, 0.027110495, 0.020693379, 0.0010211687, -0.14799021, -0.35118467, -0.10359185, 0.17371508, 0.080203995, -0.10510245, 0.10176576, 0.22656465, 0.17134638, 0.21986121, -0.110432625, -0.14227211, -0.108175665, -0.004949192, 0.07256119, 0.012826482, 0.29626644, 0.19098008, 0.20074111, 0.07172256, -0.18402319, -0.13122909, -0.10842188, 0.16904755, 0.28326827, 0.29868487, 0.19221489, -0.07720902, -0.101417795, -0.1332002, 0.11416021, -0.095586866, -0.038621582, 0.27779233, 0.07894281, 0.025374804, 0.023720149, -0.05423798, 0.15623783, 0.29647902, 0.10853965, 0.022585787, -0.1370914, -0.09762796, 0.14442532, 0.089280814, 0.31561917, 0.25107732, 0.18243583, -0.019301461, -0.1650477, 0.21479598, -0.051819853, -0.17840634, 0.2438689, -0.057496067, -0.0069247};
float conv2_bias[] = {0.26893708, 0.2748249, 0.02934367, 0.1508392};
float fc1_weight[] = {-0.009897675, 0.13827993, 0.0949577, -0.044331484, 0.13290323, 0.115376286, -0.08948629, 0.16019587, 0.11166626, 0.1287428, -0.031125125, 0.005936451, 0.17803788, -0.080749884, -0.070733316, -0.068481684, 0.046180766, 0.18784419, 0.08598663, 0.06581169, 0.1282838, 0.041417588, 0.0047685807, 0.07060231, -0.06194504, 0.090119876, 0.049422342, 0.06585609, 0.035557758, 0.09118097, -0.060372185, -0.059007447, 0.09419898, 0.050366744, 0.055754177, 0.16237803, -0.11705754, -0.11221035, -0.008640229, -0.27443424, 0.19280104, -0.11043012, -0.23021007, -0.0017219953, -0.076388784, -0.024033183, 0.08112744, 0.13641806, 0.15870923, 0.04330741, -0.067932405, 0.13549213, 0.10796431, -0.046205897, 0.16387308, 0.013470737, 0.02615077, -0.023083445, 0.029778318, -0.07184614, 0.15384218, 0.07149914, -0.03951077, 0.07735409, -0.07033487, 0.010558999, -0.094036534, 0.10300505, -0.1337568, 0.011296603, 0.036990203, 0.03961391, -0.12385057, 0.018544152, -0.064179115, -0.09570976, 0.009961217, -0.07903476, 0.06763118, -0.11203536, -0.068433814, 0.06758622, 0.10968271, -0.12894227, -0.09943195, -0.049279004, -0.12524994, 0.023439087, 0.024943119, 0.048702154, 0.08363429, -0.11596565, 0.005998041, -0.10881373, 0.10523331, -0.0052200686, 0.06081964, -0.112818435, 0.039410524, -0.049399137, -0.0061659683, -0.092316404, -0.004817472, -0.047481284, 0.012334183, -0.101927884, 0.0797296, -0.11248612, 0.0020436347, -0.08782917, -0.06385389, 0.11960715, 0.071594305, -0.07941648, -0.01810904, 0.021494431, 0.09965264, 0.0056855236, -0.110231586, -0.12877113, 0.038357325, 0.070973866, 0.041323837, 0.10976547, 0.0054391786, 0.046573795, -0.090052515, -0.071780786, -0.13234629, -0.14324918, 0.08706159, 0.009996321, 0.043459374, -0.1279681, 0.10421655, -0.03529407, 0.028382167, -0.04424613, 0.0036231636, -0.043105416, -0.10681508, -0.03949462, 0.015388604, 0.069928735, 0.07854743, -0.028974915, -0.053425677, 0.047849376, -0.0002279467, -0.048462175, -0.08197819, -0.053555533, -0.011199442, -0.057340592, 0.053481523, -0.008353048, 0.026381081, -0.008538182, -0.073177114, 0.023599198, -0.06910925, -0.13703585, 0.07650143, 0.032965705, 0.03241387, 0.054378577, -0.030117506, 0.020966327, 0.04127717, -0.0768708, -0.1118872, 0.028141178, 0.0056527257, 0.11446507, 0.08654386, 0.00249736, -0.13079807, -0.063791715, 0.042901654, 0.052199755, -0.016427701, 0.0620781, 0.09585245, -0.07845827, 0.097838834, -0.014932065, 0.04497484, 0.012241475, -0.06502931, 0.027811782, -0.024035288, 0.028823158, 0.04127913, -0.055217832, 0.009711794, 0.15780813, 0.15191448, -0.058214262, 0.08771363, 0.059301887, 0.00562346, -0.02887258, 0.1193242, 0.11648977, 0.11183124, 0.1330753, 0.03046254, 0.10561867, 0.16200644, -0.06581559, 0.14113034, 0.17033857, 0.041290578, 0.010190603, 0.030221865, 0.114014186, 0.086196266, 0.06996041, -0.03601348, 0.018201968, 0.0004941301, -0.051867217, -0.013771597, 0.10720401, -0.11019608, 0.06834111, 0.007036973, -0.0017438036, 0.036491234, -0.20444676, -0.03787163, -0.08918307, 0.07219201, 0.077935375, -0.15031733, -0.14032237, -0.09677139, 0.06161856, 0.103860095, 0.049219243, 0.053224, 0.14236704, 0.06526261, -0.07112246, 0.060394138, -0.04965634, 0.043354332, -0.036344264, -0.015395532, 0.017362684, -0.05065407, 0.059831884, 0.054060183, 0.10054051, 0.11273544, 0.15639025, -0.07001341, 0.06608241, 0.05786438, -0.0034595616, -0.037233744, 0.08686237, 0.07684799, -0.02985969, 0.11587959, -0.032887854, -0.01924202, -0.0626968, 0.01063475, 0.0015364502, -0.027689045, -0.16448408, -0.04817406, 0.1150518, -0.10083539, -0.021777842, 0.069465056, 0.014377865, 0.1321605, 0.13199256, -0.0049440186, -0.08594049, -0.09140846, -0.00369357, 0.055544343, -0.05248134, -0.0093282955, -0.13705185, 0.02214233, 0.018513046, 0.03690642, -0.08835809, 0.14201918, 0.20880581, 0.0382658, 0.054319557, -0.14925538, -0.2643135, -0.084437944, -0.095021695, -0.04297701, -0.046942852, 0.08346422, 0.08941618, 0.053908285, 0.14058752, 0.07627073, -0.03543001, 0.019384248, 0.07759272, 0.07886039, 0.028099827, 0.035364922, -0.11005173, 0.031463772, -0.11773768, -0.003397169, -0.10049763, 0.08815686, -0.04917966, -0.1516745, -0.037304256, -0.0683838, 0.08266191, 0.049119826, 0.072508395, -0.009030481, -0.040982608, 0.03493635, -0.17276347, -0.16289708, -0.19436884, -0.015636807, 0.17371, 0.1627308, 0.013993339, -0.026952732, 0.033967342, 0.020690028, -0.060362652, 0.071340114, -0.0073204506, 0.12972562, 0.11267129, -0.046045534, 0.22708365, 0.13402566, 0.09610244, -0.018391173, 0.021722851, -0.053876143, 0.018397985, 0.023747358, -0.062111013, 0.1909783, 0.2139025, 0.17459537, 0.28331733, -0.035235982, 0.2364512, 0.022309208, 0.031570118, 0.13433865, 0.10389283, 0.15909308, -0.19471715, -0.030401886, -0.012790081, 0.11216426, 0.02284797, 0.07845644, 0.15282403, -0.0860501, 0.0797325, -0.08260154, 0.015359122, -0.18221939, 0.10065361, 0.2128993, 0.13537098, -0.016435705, -0.077803575, 0.10821546, 0.11095218, -0.18536752, 0.052190065, 0.12225793, 0.023991412, 0.023331953, 0.07347185, 0.1190032, 0.010930123, 0.07572874, -0.10920424, -0.19193485, -0.1261829, -0.10887605, 0.058084026, 0.17635123, 0.11655156, -0.17827334, 0.021969823, 0.08744833, -0.021485506, 0.09737165, 0.008475202, 0.0744307, 0.103398636, -0.110378146, 0.05245774, 0.15388615, 0.032757778, 0.037993297, 0.1678531, 0.085370556, 0.14348117, -0.043756545, 0.030725438, 0.16563949, 0.26166227, 0.16251689, 0.37120843, 0.25219762, 0.11862203, -0.11785694, -0.045767155, 0.1106573, 0.28345898, 0.16850051, -0.16750638, -0.18953149, -0.119522244, 0.09361003, -0.00082988414, 0.07871952, 0.09552443, -0.16802004, -0.16444133, 0.04660983, -0.1331279, -0.1449307, 0.18364291, 0.16420603, 0.13002373, -0.21094666, -0.096001446, 0.084945, 0.18062404, 0.08895756, 0.07179694, 0.1420757, 0.005687127, -0.022014521, 0.07299069, -0.050001487, 0.15051334, 0.07157485, 0.16267215, 0.15924045, 0.103350736, -0.098237164, 0.02474594, -0.08659143, -0.12046896, 0.027036393, 0.090105556, 0.08400382, -0.06832496, 0.11324029, -0.073868476, 0.02827576, -0.01565178, 0.067525156, -0.06863766, -0.17410028, 0.004127397, 0.054731183, 0.054449756, 0.020455716, -0.1393466, -0.07988385, 0.22594798, 0.12734658, -0.12554136, -0.08231382, -0.07969698, -0.06245484, 0.07382743, 0.0332358, 0.13895443, -0.20298532, -0.17238037, -0.054212082, 0.156105, 0.054820802, -0.0300635, 0.13960017, 0.06458368, 0.075093165, 0.047430255, 0.16476533, 0.13214105, -0.028459651, -0.043151036, -0.041345514, 0.03096786, -0.0051071527, -0.13091484, 0.08758245, 0.13157696, -0.04239276, -0.21901797, 0.07294956, 0.20154445, 0.1856012, -0.02774671, 0.004339207, 0.049024645, 0.0551732, 0.08814032, -0.00010560161, 0.010375739, 0.08256573, 0.24881513, 0.059197377, -0.118946485, 0.03051597, -0.16268933, 0.25401413, 0.102264665, 0.13986629, 0.15084884, 0.08462355, -0.09416561, -0.04803948, 0.15990035, 0.109892264, -0.10044957, 0.033933707, -0.00608058, 0.08757001, -0.0082757585, 0.024843454, 0.1197272, 0.23671311, 0.22197074, 0.07875826, -0.07461752, -0.09693267, -0.046145223, -0.040343568, -0.17558593, 0.10886048, -0.04333124, -0.057664115, -0.03656822, 0.07048233, 0.118818365, 0.19513145, 0.12901704, 0.14012079, 0.015428796, -0.025153106, 0.021060206, 0.002656595, 0.063557446, 0.06164977, -0.03597002, 0.089421466, 0.080599055, -0.14881021, -0.05990138, 0.23058236, 0.23098235, -0.107835524, -0.118921705, 0.05915979, 0.19364429, -0.06758719, -0.02638358, 0.058519784, 0.17694813, 0.18529701, 0.12488403, -0.0006776293, 0.19034551, 0.21391636, 0.2006474, -0.0098348735, -0.058650117, -0.09116435, -0.18888573, 0.2173042, 0.07359592, -0.07643893, -0.041881222, 0.12711087, -0.023294812, -0.061983604, 0.06522932, 0.059703786, -0.106665045, -0.2095697, 0.07601483, 0.18225467, 0.13326466, 0.0285715, 0.026864447, 0.12477258, 0.043321628, -0.1016108, -0.18152061, -0.135711, -0.0783275, -0.02158385, -0.21310076, 0.15328036, -0.06759294, -0.22232431, -0.010395126, -0.16291657, 0.04329815, 0.24021891, 0.04455587, 0.08142366, 0.19017394, 0.12189718, -0.08624397, 0.06315685, 0.18082081, -0.047073957, 0.16716756, 0.18826418, 0.023690442, -0.05729183, 0.073729575, 0.058584437, 0.050899357, -0.047438685, -0.14328974, -0.13167441, -0.12532791, 0.18509902, 0.22448836, 0.05528788, 0.09937958, -0.06417344, 0.0004043375, -0.03294203, -0.049387604, -0.20423837, -0.091627955, 0.15302059, 0.22428311, 0.1353802, 0.16239564, 0.012274922, -0.10843401, 0.18214051, 0.17984636, -0.0150637375, 0.13451312, 0.12962562, 0.08262763, -0.009248384, 0.003973784, -0.0051617883, 0.09551352, 0.04303944, 0.05901431, 0.17050713, 0.076908015, -0.121843904, 0.017757224, 0.1915258, 0.21746868, 0.21452563, 0.061087977, -0.13119754, 0.1355263, 0.0537986, 0.13495915, 0.07456245, 0.039201826, 0.2644899, -0.2858178, -0.096913606, -0.14731091, 0.047925625, -0.12020197, 0.22519588, 0.08526994, 0.027827127, 0.045577206, 0.120150454, 0.0609283, 0.11907633, 0.05051587, 0.15842319, 0.17184788, -0.17279387, 0.12528503, 0.20305127, 0.07241989, 0.02361931, 0.03197479, -0.10347877, 0.10378546, -0.08724288, -0.10410262, 0.02927858, 0.10091303, 0.044521026, -0.08653765, -0.03362332, 0.060226783, -0.11149444, -0.02509612, -0.016162142, 0.02670572, 0.057068337, 0.01732442, -0.075207286, -0.0072552045, 0.049605135, 0.021911275, -0.058261678, 0.10526041, 0.08819373, -0.116482034, -0.12664858, -0.12907389, 0.022002479, 0.10807273, 0.11046693, -0.08671873, -0.08412689, 0.0107902195, 0.08773058, -0.08914537, -0.015138943, 0.103198044, -0.0043748384, 0.10525551, 0.08003117, -0.095395595, 0.049144763, -0.10595221, 0.109174624, 0.0561623, -0.0028128885, -0.10072133, -0.020246185, 0.044218294, -0.010056956, -0.093636625, 0.051359944, -0.0690603, -0.0023867222, -0.07434806, -0.1042093, 0.025056167, -0.057982378, -0.032927427, 0.020880634, -0.07659091, -0.08285803, 0.010397428, -0.055889033, 0.08844906, -0.1398095, 0.088296786, 0.056724943, 0.11232637, -0.117441304, -0.1321139, 0.058597855, 0.09269817, 0.078986056, -0.13474658, 0.059349768, -0.1211834, 0.099801965, -0.08548054, 0.084433496, -0.04872883, -0.009490347, 0.03759789, -0.12614979, -0.004901857, -0.05564219, -0.1255372, -0.07997014, -0.11295267, -0.016960042, -0.07668603, 0.07546007, -0.0022623695, -0.01591724, -0.081216484, -0.09519056, 0.06794998, -0.08486561, -0.019689426, 0.0032444894, 0.09092556, -0.090606436, -0.046793744, -0.027231053, 0.040445983, 0.08719607, 0.011910483, -0.060300365, 0.06978704, -0.027849838, 0.053406507, 0.072655365, 0.029439854, 0.06762755, -0.00078767026, 0.003906183, -0.019769637, -0.019511554, 0.09432628, -0.13538139, 0.021470184, -0.1275451, 0.113717265, -0.11039471, 0.0042989906, 0.07835711, -0.112207815, 0.0853425, 0.08802604, -0.032035913, 0.10774905, 0.062379185, 0.050318014, 0.11150815, 0.03939589, 0.009279025, -0.009740888, 0.15815997, 0.22781669, 0.1244388, -0.09453119, 0.027733196, 0.05846375, 0.18743752, 0.1578926, 0.0862085, 0.11467534, 0.014247741, -0.12266992, -0.06600825, 0.026925009, 0.0037726802, -0.15285274, -0.040263012, 0.12100165, -0.00673655, -0.020967413, -0.08283289, 0.0901106, 0.12543735, 0.19639881, 0.012926269, -0.086391374, -0.19126314, -0.12561442, -0.14561775, -0.23485795, 0.060527172, -0.053933345, -0.28269854, -0.15414333, -0.1256678, 0.21082503, 0.11121518, 0.1593116, -0.020645605, -0.049160082, -0.08647357, 0.045483615, 0.10961886, 0.16310246, 0.12723987, 0.049250755, 0.0026896873, -0.14938773, -0.042629424, -0.102629274, 0.0019714492, -0.035526987, 0.048299614, 0.007024308, -0.060889725, 0.063932426, -0.18802315, -0.19642955, -0.11067001, 0.050531752, -0.06264353, 0.11113283, -0.016883979, 0.03979161, 0.19118263, 0.24510464, -0.06405393, -0.10067264, 0.1761184, 0.12463991, 0.008493251, 0.040891115, -0.06647648, -0.14202353, 0.018984389, -0.034008883, -0.053650327, 0.00942683, -0.01739034, -0.0574645, 0.057726264, 0.100195, 0.0883388, 0.10693722, -0.059807733, 0.07784731, 0.03285641, -0.039326925, -0.076637775, -0.34496284, 0.0747492, 0.05326202, -0.040611535, -0.13414072, -0.062095113, -0.13367228, -0.02132152, 0.18120514, -0.0657992, 0.23570223, 0.16414596, -0.015578896, 0.095688365, 0.037257507, -0.053850826, -0.14247149, 0.12333951, 0.11185158, 0.1712618, 0.13260825, -0.06213412, -0.044328474, 0.07513381, 0.15475239, 0.15836053, 0.12719911, -0.099633455, 0.058915716, 0.06988513, -0.03248662, 0.04681424, 0.01924021, 0.0984803, -0.05123053, 0.003672995, 0.020904712, -0.062786885, 0.05990801, -0.1102444, -0.03751621, 0.16051625, 0.092328995, 0.17229882, 0.093804926, 0.16202834, 0.03280186, 0.07406146, 0.003927166, 0.039704606, 0.08046191, 0.07642878, 0.011644999, 0.15516476, -0.020125693, 0.100992136, 0.15344714, 0.044466764, 0.11477961, -0.018058378, 0.13346201, -0.106981, -0.12053179, 0.16891886, 0.13871273, 0.0490142, 0.10999579, 0.007873497, -0.09241794, 0.016573245, 0.0116799455, 0.058163002, -0.10587146, -0.0051428806, -0.11726877, 0.12373648, 0.0043393653, -0.0050261384, -0.07668249, 0.13626811, 0.1698335, -0.030255724, -0.052778494, -0.00933496, -0.060494665, 0.033663947, 0.12092421, -0.0064861327, 0.06695981, 0.13971174, 0.14742833, 0.050733652, -0.03172365};
float fc1_bias[] = {0.052564144, 0.040340673, -0.055746097, -0.0014546186, 0.060782395, 0.03394823, 0.07126026, -0.04036732, 0.1312073, -0.037697755, -0.01769467, -0.1298649, -0.1072876, 0.021264818, 0.00595239, -0.0389274};
float fc2_weight[] = {0.19365264, 0.10189966, 0.12329497, 0.09767715, -0.083712004, -0.34250903, -0.17119901, -0.08188112, 0.07334605, 0.32603988, -0.19695655, -0.0022283755, -0.21334565, 0.27907547, 0.23071015, 0.11951019, 0.1035596, -0.120172486, -0.1180313, 0.16515292, -0.04710282, 0.13361832, 0.19470744, -0.39179978, -0.14355226, -0.3822507, 0.18499424, 0.17027359, 0.09410825, -0.115899466, -0.3181668, 0.30009955, -0.16815399, -0.10568672, -0.1458005, -0.041113745, -0.012878777, 0.14917599, 0.18458165, -0.37591103, -0.38810682, 0.14780875, -0.10755375, 0.13725628, 0.17024805, -0.22468948, 0.29412708, -0.029715836, -0.0042225816, 0.0895506, 0.14298408, -0.25746524, 0.2651254, -0.051364478, 0.25236636, 0.09337212, 0.04035527, -0.15022188, 0.0030662245, 0.17359787, -0.09966657, -0.304227, -0.040310394, 0.019079756, -0.12521642, -0.2540659, 0.0824186, -0.14095858, -0.24302867, -0.13799366, -0.028447187, 0.090576105, -0.08722336, -0.08478361, 0.012229821, 0.092280135, -0.14493255, -0.23318355, -0.55772245, -0.31074327};
float fc2_bias[] = {0.20944329, 0.1839379, -0.024862392, 0.1881234, -0.09327147};

float TEST_DATA[] = {-0.9654, -3.4293, -4.4667, -4.5023, -3.8730, -2.5937, -1.7200, -1.5612,
                    -0.7564, -0.1136, -0.1773,  0.0341, -0.0760, -0.2694,  0.0000,  0.0000,
                    -0.1312,  0.0744, -0.1976, -0.3397, -0.1589, -0.2454, -0.3303, -0.3264,
                    -0.0581, -0.1224, -0.4945, -0.3842, -0.2844, -0.3558,  0.0000,  0.0000,
                    -0.4960, -0.4181, -0.2483, -0.3660, -0.5395, -0.8620, -0.7144, -0.5478,
                    -0.5552, -0.3743, -0.4543, -0.4992, -0.5265, -0.2554,  0.0000,  0.0000,
                    -0.0709, -0.1248, -0.1262,  0.1325, -0.0571,  0.1503,  0.1577, -0.1258,
                    0.2120,  0.1487,  0.0473,  0.1010,  0.0151,  0.1584,  0.0000,  0.0000,
                    0.1523,  0.2693,  0.3934,  0.1426,  0.0885,  0.1790,  0.2097,  0.0527,
                    0.0170,  0.2148,  0.2136,  0.2796,  0.3542,  0.3740,  0.0000,  0.0000,
                    0.4969,  0.6265,  0.4366,  0.2441,  0.5454,  0.5644,  0.4945,  0.5715,
                    0.5834,  0.7555,  0.3941,  0.2413,  0.4091,  0.3938,  0.0000,  0.0000,
                    0.5107,  0.3573,  0.1080,  0.2704,  0.4087,  0.4090,  0.4568,  0.4138,
                    0.4661,  0.2157,  0.2083,  0.3694,  0.6835,  1.0831,  0.0000,  0.0000,
                    1.2298,  1.3346,  1.5986,  2.0025,  2.0582,  1.8667,  1.8559,  1.9671,
                    1.6299,  1.3282,  1.2915,  0.9486,  0.4437, -0.0097,  0.0000,  0.0000,
                    -0.2846, -0.4130, -0.4150, -0.2937, -0.4654, -0.3870, -0.5038, -0.5675,
                    -0.3288, -0.5436, -0.7198, -0.7287, -0.3809, -0.3796,  0.0000,  0.0000,
                    -0.4412, -0.2889,  0.2138,  0.8383,  1.3437,  1.3139,  1.2051,  1.0584,
                    0.8524, -0.0243, -0.1411,  0.3082,  0.5003, -1.4674,  0.0000,  0.0000,
                    0.0000,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000,
                    0.0000,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000,
                    0.0000,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000,
                    0.0000,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000,
                    0.0000,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000,
                    0.0000,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000,
                    0.0000,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000,
                    0.0000,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000,
                    0.0000,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000,
                    0.0000,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000,
                    0.0000,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000,
                    0.0000,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000};


// ReLU激活函数：对单个输入进行激活，如果输入小于0，则输出0，否则输出输入值。
float activate_relu(float x) {
    return (x > 0) ? x : 0;
}

// 对数组中的每个元素应用ReLU激活函数。
void activate_relu_array(float* array, int size) {
    for (int i = 0; i < size; i++) {
        array[i] = activate_relu(array[i]);
    }
}

// Softmax函数：对输入数组进行归一化处理，使数组元素值非负且和为1。
void softmax(float *input, int length) {
    float max = input[0];
    float sum = 0.0;

    // 找到数组中的最大值，用于数值稳定性
    for (int i = 1; i < length; i++) {
        if (input[i] > max) {
            max = input[i];
        }
    }

    // 计算指数的和，同时减去最大值以增加数值稳定性
    for (int i = 0; i < length; i++) {
        input[i] = exp(input[i] - max);
        sum += input[i];
    }

    // 归一化步骤
    for (int i = 0; i < length; i++) {
        input[i] /= sum;
    }
}

// 2D卷积操作：在输入数据上应用卷积核，通常用于特征提取。
void convolve_2d(float *input_data, 
                 const cnn_kernel_t *conv_params, 
                 float *output_data, 
                 int input_height, int input_width,
                 const char in_place_flag) {
    int kernel_size = conv_params->kernel_size;
    int pad = conv_params->padding;
    int stride = conv_params->stride;
    int out_channels = conv_params->out_channels;
    int in_channels = conv_params->in_channels;

    int output_height = (input_height + 2 * pad - kernel_size) / stride + 1;
    int output_width = (input_width + 2 * pad - kernel_size) / stride + 1;

    int memsize = (out_channels* output_height * output_width) * sizeof(float);
    float *tmp_buffer = (float *)malloc(memsize);

    // if (tmp_buffer != NULL) // 如果内存分配成功
    // {
    //     printf("memory allocated at:%x\n", tmp_buffer);
    // }
    // else
    // {
    //     printf("not enough memory!\n");
    // }

    // 初始化输出数据，包括偏置
    for (int oc = 0; oc < out_channels; oc++) {
        for (int i = 0; i < output_height * output_width; i++) {
            tmp_buffer[oc * output_height * output_width + i] = conv_params->bias[oc];
        }
    }

    // 执行卷积操作
    for (int oc = 0; oc < out_channels; oc++) {
        for (int ic = 0; ic < in_channels; ic++) {
            for (int y = 0; y < output_height; y++) {
                for (int x = 0; x < output_width; x++) {
                    float sum = 0.0;
                    for (int ky = 0; ky < kernel_size; ky++) {
                        for (int kx = 0; kx < kernel_size; kx++) {
                            int in_y = y * stride + ky - pad;
                            int in_x = x * stride + kx - pad;
                            if (in_y >= 0 && in_y < input_height && in_x >= 0 && in_x < input_width) {
                                sum += input_data[(ic * input_height + in_y) * input_width + in_x] *
                                       conv_params->weight[((oc * in_channels + ic) * kernel_size + ky) * kernel_size + kx];
                            }
                        }
                    }
                    tmp_buffer[(oc * output_height + y) * output_width + x] += sum;
                }
            }
        }
    }

    if(in_place_flag){
        memcpy(input_data, tmp_buffer, memsize);
    }
    else{
        memcpy(output_data, tmp_buffer, memsize);
    }
    
    free(tmp_buffer);

    tmp_buffer = NULL;
}

// 最大池化操作：在输入数据的局部区域内找到最大值，通常用于降低数据的空间维度和提取重要特征。
void maxpooling2d(float *input_data, 
                  const int input_height, 
                  const int input_width, 
                  const int input_channels,
                  const maxpooling_t *paras, float *output_data) {
    int pool_size = paras->pool_size;
    int stride = paras->stride;

    int output_height = (input_height - pool_size) / stride + 1;
    int output_width = (input_width - pool_size) / stride + 1;

    for (int c = 0; c < input_channels; ++c) {
        for (int y = 0; y < output_height; ++y) {
            for (int x = 0; x < output_width; ++x) {
                float max_val = -FLT_MAX;
                for (int i = 0; i < pool_size; ++i) {
                    for (int j = 0; j < pool_size; ++j) {
                        int in_y = y * stride + i;
                        int in_x = x * stride + j;
                        int idx = (c * input_height * input_width) + (in_y * input_width) + in_x;
                        if (in_y < input_height && in_x < input_width) {
                            max_val = fmax(max_val, input_data[idx]);
                        }
                    }
                }
                int out_idx = (c * output_height * output_width) + (y * output_width) + x;
                output_data[out_idx] = max_val;
            }
        }
    }
}

// 矩阵-向量乘法：用于全连接层，计算权重矩阵和输入向量的乘积。
void matrix_vector_multiply(float* matrix, float* vector, float* result, int rows, int cols) {
    for (int i = 0; i < rows; i++) {
        result[i] = 0;
        for (int j = 0; j < cols; j++) {
            result[i] += matrix[i * cols + j] * vector[j];
        }
    }
}

// 向量加法：将两个向量相加，通常用于在全连接层中添加偏置。
void vector_add(float* vector1, float* vector2, int length) {
    for (int i = 0; i < length; i++) {
        vector1[i] += vector2[i];
    }
}

// 全连接层：执行矩阵-向量乘法和向量加法，是神经网络中的基本组成部分。
void full_connect_layer(float* input_data,
                        float* weight, 
                        float* bias,
                        int rows, int cols,
                        float* output_data) {
    matrix_vector_multiply(weight, input_data, output_data,  rows, cols);
    vector_add(output_data, bias, cols);
}

void TEST_CNN(void)
{
    int out_h = 16;
    int out_w = 16;
    float buffer[4*16*16];

    cnn_kernel_t conv_params;
    conv_params.weight = conv1_weight;
    conv_params.bias = conv1_bias;
    conv_params.in_channels = 1;
    conv_params.out_channels = 2;
    conv_params.kernel_size = 3;
    conv_params.padding = 1;
    conv_params.stride = 1;

    // conv1
    convolve_2d(TEST_DATA, &conv_params, buffer, out_h, out_w, 0);
    activate_relu_array(buffer, out_h*out_w*conv_params.out_channels);

    // maxpool: Pool size of 2 and stride of 2
    maxpooling_t params = {2, 2}; // 
    maxpooling2d(buffer, out_h, out_w, 2, &params, buffer);

    // conv2
    conv_params.in_channels = 2;
    conv_params.out_channels = 4;
    conv_params.weight = conv2_weight;
    conv_params.bias = conv2_bias;
    out_h = 8;
    out_w = 8;
    convolve_2d(buffer, &conv_params, NULL, out_h, out_w, 1);
    activate_relu_array(buffer, out_h*out_w*conv_params.out_channels);

    // maxpool: Pool size of 2 and stride of 2
    maxpooling_t params2 = {2, 2}; 
    maxpooling2d(buffer, out_h, out_w, 4, &params2, buffer);

    float fc1_out[4*4*4];
    full_connect_layer(buffer, fc1_weight, fc1_bias, 16, 64, fc1_out);
    activate_relu_array(fc1_out, 16);

    float fc2_out[5];
    full_connect_layer(fc1_out, fc2_weight, fc2_bias, 5, 16, fc2_out);
    // activate_relu_array(fc2_out, 5);
    softmax(fc2_out, 5); // 计算类别概率

    for(int k=0; k<1; k++){
        for(int i=0; i<1; i++){
            for(int j=0; j<5; j++){
                printf("%f ,", fc2_out[k*16 + i*4 + j]);
            }
            printf("\n");
        }
    }
}


int main(void)
{
    printf("It's CNN Demo! \n");

    TEST_CNN();

    return 1;
}